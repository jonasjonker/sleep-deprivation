---
title: "Patterns of performance degradation during sleep restriction of long distance truck drivers "
output: 
pdf_document:default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r libraries, include=F}
library(tidyverse)
library(lattice)
library(lme4)
library(arm)
#library(pkbrtest)
library(ggplot2)
```

## Presentation of the case study
We are analysing the effect of sleep deprivation on reaction time of long distance truck drivers. There are 18 subjects in the dataset and for each subject, the reaction time was measured for 10 days. The subjects were allowed only a limited amount of sleep for 10 subsequent days.
Each subjects reaction time was measured several times on each day of the trial.

Reaction time is measured with a psychomotor vigilance task (PVT), which measures the speed with which subjects respond to a visual stimulus.

Is there any relation between reaction time and the number of days of sleep deprivation?



## Exploratory analysis
```{r data_wrangling}
sleep <- read.table('sleep.txt')
head(sleep, 12)
```
This dataset contains multiple measurements for each subject on consecutive days, with as response variable the continuous variable reaction time and explanatory variable Days. Since there are 10 measurements for each subject, it is a longitudinal study.
The dataset of 18 subjects is balanced with an equal amount of measurements for each subject.


### Spaghetti Plot
To visualise the individual reaction times and how they compare to the mean, a spaghetti plot was made.
This revealed that there was variation in intercept or starting reaction time on day 0, this variation increased with subsequent days.
For most subjects, the reaction time increased with amount of days of sleep deprivation. This increase is also visible in the mean.


```{r spaghetti, echo=FALSE, fig.align="center", out.width="80%", out.height="60% "}
average_reaction_time <- sleep %>%
  group_by(Days) %>%
  summarise(mean_reaction_time   = mean(Reaction),
            median_reaction_time = median(Reaction),
            sd_reaction_time     = sd(Reaction))

sleep_spag_plot <- ggplot(sleep) +
  geom_line(aes(Days, Reaction, colour=factor(Subject)),
            show.legend=FALSE) +
  geom_line(data= average_reaction_time,
            aes(Days, mean_reaction_time),
            colour = "BLACK",
            size   = 1.4) + 
  labs(title   = "Spaghetti Plot",
       caption = "Already from this plot you can assume that the reaction time is increasing with increasing number of days of sleep deprivation.")
sleep_spag_plot

# TODO axes benoemen
```

## Boxplot
Boxplots were made to get a quick summary of the datasets characteristics. The mean and median seem to show a similar increase throughout the study. For day nr 6, 7 and 10, outliers are observed.  The variance increases with an increase in days of sleep deprivation, the interquartile range appears to increase not as strong as the minimum and maximum of the boxplot. To put together, some subjects deviate more from the mean with an increase in in days of sleep deprivation resulting.
The violin plot supports these above observations of the distribution of the data.

```{r boxplot, fig.align="center", out.width="80%"}
ggplot(sleep) + 
  geom_boxplot(aes(Days, Reaction, colour=factor(Days)),
               show.legend = FALSE) +
  geom_line(data   = average_reaction_time,
            aes(Days, mean_reaction_time),
            colour = "black",
            size   = 0.5) +
  labs(title   = "Boxplot",
       caption = "It seems as if there's a linear trend between the number of days of sleep deprivation and the reaction time. Also the variance of the reaction time seems to increase with increasing days of sleep deprivation. (at Day 9: 5 outliers)")
       
       ##TODO add violin plot, add axis      
```

## Summary
```{r descriptive_stats, fig.align="center"}
sleep.mean <- tapply(sleep$Reaction, list(sleep$Days), mean)
sleep.sd   <- tapply(sleep$Reaction, list(sleep$Days), sd)
sleep.var  <- tapply(sleep$Reaction, list(sleep$Days), var)
sleep.n    <- table(sleep$Days)

overview   <- cbind(c(0:9), sleep.mean, sleep.sd, sleep.var, sleep.n)
colnames(overview) <- c('Days', 'Mean', 'SD', 'Var', 'n')
knitr::kable(round(overview, 2), "pandoc")
```
Calculation of the mean, standard deviation and variance for each day on all subjects, further support our exploratory plots: an increase in the mean and variance with more days of sleep deprivation.



## Mean evolution
```{r mean_err, fig.align="center", out.width="80%"}
## TODO? change to ggplot instead of plot?
## example:
# sleep_descr_stats <- sleepf %>%
#   dplyr::group_by(days) %>%
#   dplyr::summarise(reaction_mean  = mean(reaction),
#                    reaction_sd    = sd(reaction)) %>% 
#   dplyr::mutate(reaction_upper_se = reaction_mean + reaction_sd,
#                 reaction_lower_se = reaction_mean - reaction_sd) %>% 
#   dplyr::ungroup()
#
# ggplot2::ggplot() +
# geom_line(aes(x=days, y=reaction_mean, group=1),
#          size=1) +
# geom_errorbar(aes(x=days, ymin=reaction_lower_se, ymax=reaction_upper_se),
#               size=.4,
#              alpha=.6)

# General function to plot error bars
errbar <- function(x, y, height, width, lty=1, col="black"){
  arrows(x, y, x, y+height,
         angle  = 90,
         length = width,
         lty    = lty,
         col    = col)
  arrows(x, y, x, y-height,
         angle  = 90,
         length = width,
         lty    = lty,
         col    = col)
}

## Plotting mean evolution
plot(c(0:9), overview[,2] ,
     type = "b",
     xlim = c(0,10),
     ylim = c(150,480),
     xlab = "Days",
     ylab = "Reaction",
     axes = F,
     main = "Mean evolution (with 1 SE intervals)")

axis(side=1,at=c(0:9),labels=c(0:9))
axis(side=2,at=seq(200,450,50))

box()
points(c(0:9), overview[,2],
       type="b",
       col="red")
errbar(c(0:9), overview[,2], sleep.sd, 0.1,
       col="red")
```
To further supports our previous findings, we looked at the mean evolution.
Here, an increasing trend of reaction time with increasing number of days is also observed, together with expanding standard deviation (errorbars).





## Correlation
```{r}
## Reshaping the data into a wide form
sleep.resh <- reshape(sleep,
                      timevar   = "Days",
                      idvar     = c("Subject"),
                      direction = "wide")
knitr::kable(sleep.resh, "pandoc")
```
```{r}
# check normality of variables Reaction.X
for (i in c(2:11)){
  print(shapiro.test(sleep.resh[,i]))
}
```
```{r spearman, fig.align="center", out.width="80%"}
## Correlation between the Reaction scores at different days
cor(sleep.resh[, 2:11], method='spearman')

pairs(sleep.resh[, 2:11])
##TODO add cor + colours fancy plot
```

The shapiro test revealed a non normal distribution of day 9. Thus, we performed the spearman correlation method instead of pearson.

There is a correlation higher then 0.6 between subsequent days (e.g. between Day 8 and 9, between Day 3 and 4, ...). The further the days are apart, the lower the correlation (e.g. low correlation between Day 1 and Day 8). Aligning nicely with our previous results, there is a linear trend between the number of Days and reaction time.

## Regression per person
```{r trellis, fig.align="center", out.width="80%"}
## Trellis graph
## Displaying the linear regression per person

cf <-sapply(sleep$Subject, 
            function(x) coef(lm(Reaction~Days, data=subset(sleep, Subject==x))))

Sx <-reorder(sleep$Subject, cf[1,]) 
# 
xyplot(Reaction ~ Days|Sx,
       data          = sleep,
       type          = c('p', 'r'),
       auto.key      = T,
       aspect        = "xy",
       par.settings  = list(axis.text=list(cex=0.6),
                           fontsize=list(text=8, points=10)),
       scales=list(x = list(at = c(0:9), labels = c("0","1","2", "3", "4", "5", "6", "7", "8", "9"))))
```
We made a trellis graph to visualise individual trends and slopes. In addition, this reveals pontential interaction between intercept and slope. This graph suggests that slope and intercepts are independent of each other, due to no observable trend between increasing slope and intercept. All subjects have a positive slope beside subject 335. The linear regression lines fit the datapoints closely, suggesting  that a linear model is appropriate to represent this dataset.

TO DISCUSS: correlation between slope/intercept?

## Between subject variability

```{r histograms, fig.align="center", out.width="80%"}
## Linear regression per participant of Reaction on Days

## Coefficients
lin.reg.coef  <- by(sleep, sleep$Subject,
                   function(data) coef(lm(Reaction ~ Days, data=data)))
lin.reg.coef1 <- unlist(lin.reg.coef)
names(lin.reg.coef1) <- NULL
lin.reg.coef2 <- matrix(lin.reg.coef1,
                        length(lin.reg.coef1)/2,
                        2,
                        byrow = TRUE)

## R squared
lin.reg.r.squared <- by(sleep, sleep$Subject,
                        function(data) summary(lm(Reaction ~ Days, data=data))$r.squared )
lin.reg.r.squared1<- as.vector(unlist(lin.reg.r.squared))

## Histograms
par(mfrow=c(3,1))
hist(lin.reg.coef2[,1],
     xlab = "Intercept",
     col  = "lightblue",
     main = "Histogram of individual intercepts")
hist(lin.reg.coef2[,2],
     xlab = "Slope",
     col  = "lightblue",
     main = "Histogram of individual slopes")
hist(lin.reg.r.squared1,
     xlab = "R squared",
     col  = "lightblue",
     main = "Histogram of individual R squared")

```

The individual intercepts don't seem to bee normally distributed. The slopes seem to follow a normal distribution. The majority of the individual models seem to fit the individual data well (high R squared), but there are also some models that don't fit the data very well.

## Fitting the model - with REML
```{r}
sleep.reml <- lmer(formula = Reaction ~ 1 + Days + (1 + Days|Subject),
                   data=sleep)
summary(sleep.reml) 
```
## Values
$$\begin{align}
\gamma_{00} \text{ or } \gamma_{0}  &= 251.405 \\
\gamma_{10} \text{ or } \gamma_{1}  &= 10.467  \\
\\
\sigma_{\epsilon}^{2} &= 654.94 \\
\sigma_{0}^{2} &= 611.90 \\
\sigma_{1}^{2} &= 35.08 \\
corr(b_{0i}, b_{1i}) &= 0.07
\end{align}$$

## Testing fixed effects - with Wald
```{r}
confint(sleep.reml,  par=5:6, method='Wald', oldNames=F)
```
Both confidence intervals do not contain 0 => Intercept != 0, Days effect != 0

## Testing fixed effects - with bootstrap and profile likelihood
```{r}
confint(sleep.reml,
        method    = 'boot',
        boot.type = 'perc',
        oldNames  = F,
        nsim      = 500)
confint(sleep.reml,
        level    = 0.95,
        method   = 'profile', 
        oldNames = F)
```
same result: Both confidence intervals do not contain 0 => Intercept != 0, Days effect != 0


TO BE CONTINUED....

## likelihood ratio test with anova
```{r}

```

TODO: check if residuals are normally distributed
```{r}
resid <- residuals(sleep.reml)
shapiro.test(residuals(sleep.reml))
hist(resid)
```

## OLS vs LMM estimates
```{r}
sleep.o <- ranef(sleep.reml)$Subject
knitr::kable(head(sleep.o), format = "pandoc")
```
